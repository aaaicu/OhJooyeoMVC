<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="advertisement">

	<select id="getWorshipAd" parameterType = "map" resultType="map">
		<![CDATA[
			SELECT ad.church_id churchId, 
				ad.worship_id worshipId, 
				ad.advertisement_id adId, 
				ad.content, 
				ad.title, 
				ad.order,
				w.version
			FROM ohjooyeo.ADVERTISEMENT ad,
			ohjooyeo.WORSHIP w
            WHERE ad.worship_id = w.worship_id
			AND ad.worship_id = #{worshipId}
			AND ad.church_id = #{churchId}
			ORDER BY ad.order
		]]>		
	</select>
	<insert id="insertVOList" parameterType = "kr.co.ohjooyeo.vo.WorshipAdVO">
		<selectKey resultType="string" keyProperty="advertisement_id" order="BEFORE">
        SELECT IFNULL(MAX(#{list[0].adId}),0) + 1 FROM ohjooyeo.ADVERTISEMENT        
  		</selectKey>    
		<foreach collection="list" item = "vo" index= "index" separator = ";">
			INSERT INTO `ohjooyeo`.`ADVERTISEMENT` (`church_id`, `worship_id`, `advertisement_id`, `order`, `title`, `content`) 
			VALUES (#{vo.churchId}, #{vo.worshipId}, (#{advertisement_id}+#{index}),  #{vo.order}, #{vo.title},#{vo.content})
		</foreach>
	</insert>
	
	<update id="updateVOList" parameterType="kr.co.ohjooyeo.vo.WorshipAdVO">
	<!-- 다중 업데이트 가능하게하려면 jdbc 커넥션 url에 다음의 내용을 추가하여야 함 ==> &amp;allowMultiQueries=true  -->
		<foreach collection="list" item = "vo" separator = ";">	
			UPDATE ohjooyeo.ADVERTISEMENT 
			SET ohjooyeo.ADVERTISEMENT.order = #{vo.order}, 
				ohjooyeo.ADVERTISEMENT.title = #{vo.title},
				ohjooyeo.ADVERTISEMENT.content = #{vo.content}
			WHERE church_id = #{vo.churchId}
			AND worship_id = #{vo.worshipId} 
			AND advertisement_id = #{vo.adId}
		</foreach> 
	</update>
	
	<delete id="deleteVOList" parameterType="map">
		<foreach collection="list" item = "id" separator = ";" >	
			DELETE FROM ohjooyeo.ADVERTISEMENT
			WHERE worship_id = #{worshipId} 
			AND advertisement_id = #{id}
		</foreach>
	</delete>
	
	<delete id="deleteWorshipAd" parameterType="map">
		DELETE FROM ohjooyeo.ADVERTISEMENT
		WHERE church_id = #{churchId} 
		AND worship_id = #{worshipId} 
	</delete>
</mapper>